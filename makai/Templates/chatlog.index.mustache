<html>
   <head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width,maximum-scale=1">
      <!-- Some pre-requisites for auto-chatdraw -->
      <script src="{{root}}randomous.js?v={{appversion}}"></script>
      <!--<script src="{{root}}randomousCanvas.js?v={{appversion}}"></script>-->
      <script src="{{root}}chatdraw.js?v={{appversion}}"></script>
      <!--<script src="{{root}}index.js?v={{appversion}}"></script>-->
      <script src="{{root}}extras.js?v={{appversion}}"></script>
      <script src="{{root}}lz-string.min.js?v={{appversion}}"></script>
      <style>
input[type="number"] {
   width: 3em;
}
.error {
    color: red;
}
.chatdrawbutton {
   border: none;
   background: none;
   cursor: pointer;
   color: red;
   margin: 0;
   margin-right: 0.3em;
   line-height: 0;
   padding: 0;
}
.chatdrawcanvas {
   border: 1px solid #777;
}
      </style>
      <script>
window.onload = function()
{
    results.innerHTML = results.innerHTML.replaceAll(/^([^:]+)(:\d+:)([^\[]+\[\d+:\d+\].?:\s*)(.*)$/gm, function(all, gpre, gnum, usr, dat)
    {
       if(dat.length > 100 && /^[A-Za-z\d+/]+=*$/.test(dat))
       {
         var button = document.createElement("button");
         button.className = "chatdrawbutton";
         button.innerHTML = "&#9998;";
         button.dataset.rawdata = dat;
         button.setAttribute("onclick", "tryChatDraw(this)");
         var dataElem = document.createElement("span");
         dataElem.textContent = dat;
         dataElem.class = "chatdrawdata";
         return gpre + gnum + usr + button.outerHTML + dataElem.outerHTML;
       }
       else
       {
          return gpre + gnum + usr + dat;
       }
    });
    results.innerHTML = results.innerHTML.replaceAll(/(https?:\/\/[^\s]+)/g, function(a, b)
    {
        var href = encodeURI(b);
        return '<a href="' + href + '" target="_blank">' + href + '</a>';
    });
    {{#chatlogurl}}
    results.innerHTML = results.innerHTML.replaceAll(/^([^\-][^\.]*)(\.txt)/gm, function(a, b, c)
    {
        var name = b + c;
        var href = encodeURI("{{{chatlogurl}}}/" + name);
        return '<a href="' + href + '" target="_blank">' + name + '</a>';
    });
    {{/chatlogurl}}
};
function tryChatDraw(button)
{
   try
   {
      var canvas = ChatDrawUtilities.ChatDrawToFrame(button.dataset.rawdata).canvas;
      canvas.className = "chatdrawcanvas";
      var dataElem = button.nextSibling;
      dataElem.parentNode.removeChild(dataElem);
      button.parentNode.replaceChild(canvas, button);
   }
   catch(ex)
   {
      alert("Couldn't convert chatdraw, it might not be drawing! See console for details");
      console.log(ex);
   }
}
      </script>
   </head>
   <body>
      <form>
         <input name="search" type="text" placeholder="grep search" value="{{get.search}}">
         <input name="filefilter" type="text" placeholder="file pattern" value="{{get.filefilter}}">
         <span># Before:</span>
         <input name="before" type="number" min="0" max="25" value="{{get.before}}">
         <span># After:</span>
         <input name="after" type="number" min="0" max="25" value="{{get.after}}">
         <input type="submit">
      </form>
      {{#error}}
      <pre class="error">{{error}}</pre>
      {{/error}}
      {{#get.search}}
      <div class="results">
        <h3>Search results for: {{get.search}}{{#get.filefilter}} in files '{{get.filefilter}}'{{/get.filefilter}}</h3>
        <p>Command: {{command}}</p>
        <pre id="results">{{result}}{{^result}}No results!{{/result}}</pre>
      </div>
      <footer>Search took: {{time}} sec</footer>
      {{/get.search}}
      <div style="display: none">{{searchfolder}}</div>
   </body>
</html>